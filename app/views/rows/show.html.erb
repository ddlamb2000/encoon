<% @grid_cast = Row.select_grid_cast(@grid.uuid, @row.uuid) if @grid.present? and @row.present? %>

<% content_for :navigator do %>
  <% unless @grid.blank? or @row.blank? %>
    <% if @grid.present? and @row.present? %>
      <article class="article">
        <% if user_signed_in? %>
          <span id="more-title" class="button">
            <%= icon('information') + ("&nbsp;" + I18n.t('actions.more')).html_safe %>
          </span>
          <div class="slideButton">
            <input type="checkbox" id="more-button" <%= session[:show_details] ? 'checked' : '' %> />
            <label for="more-button"></label>
          </div>
          <section id="more-content" style="display: none;"></section>
          <script>
            function showDetails() {
              if ($("#more-button").attr('checked')) {
                $("#more-content").html('<%= escape_javascript(render :partial => "home/loading") %>');
                $("#more-content").show();
                $("#more-content").load("<%= url_for(:action => "details", :grid_id => @grid.uuid, :id => @row.id) %>");
                $.ajax("<%= url_for(set_path(:flag => "show_details")) %>");
                $("#more-title").addClass("highlighted");
              } 
              else {
                $("#more-title").removeClass("highlighted");
                $("#more-content").hide();
                $.ajax("<%= url_for(unset_path(:flag => "show_details")) %>");
              }
            };
            showDetails();
            $("#more-button").click(function (event){
              showDetails();
            });
          </script>
        <% end %>
      </article>
    <% end %>
    <article class="article">
      <ul>
        <% if @grid_cast.present? and @grid_cast.can_select_data? %>
          <li>
            <%= link_to icon('greenright')  + ("&nbsp;" + I18n.t('actions.data')).html_safe, 
                        :controller => 'rows', :grid_id => @grid_cast.uuid %>
          </li>
        <% elsif @grid.uuid != Grid::ROOT_UUID and @grid.can_select_data? %>
          <li>
            <%= link_to icon('greenright') + ("&nbsp;" + I18n.t('actions.data')).html_safe, 
                        :controller => 'rows', :grid_id => @grid.uuid %>
          </li>
        <% end %>
        <% if @grid.uuid != Grid::ROOT_UUID %>
          <li>
            <%= link_to_unless_current icon('table') + ("&nbsp;" + I18n.t('general.grid_design')).html_safe, 
                                       :controller => 'rows', 
                                       :action => 'show', 
                                       :grid_id => Grid::ROOT_UUID, 
                                       :id => @grid.uuid %>
          </li>
        <% end %>
        <% if @grid.present? and @row.present? %>
          <% if @row.has_attachment? %>
      		    <% if @row.has_photo? %>
  			        <% for document in @row.row_attachments %>
  			          <% if document.photo? %>
                    <li>
  			              <img src="<%= url_for(:action => 'photo', :grid_id => @grid.uuid, :id => @row.uuid, :photo_id => document.id) %>", height=128/>
                    </li>
  			          <% end %>
  			        <% end %>
   						<% end %>
      		    <% if @row.has_document? %>
  			        <% for document in @row.row_attachments %>
  			          <% if document.document? %>
  			            <li>
    			            <%= icon "document" %>
    			            <a href="<%= url_for(:action => 'file', :grid_id => @grid.uuid, :id => @row.uuid, :file_id => document.id) %>">
    			              <%= document.file_name %></a>
  			            </li>
  			          <% end %>
  			        <% end %>
      				<% end %>
      		<% end %>
   			  <% for attached_grid in Grid.select_referenced_grids(@grid.uuid) %>
    				  <% @filters = [{:column_uuid => attached_grid.column_uuid, :row_uuid => @row.uuid, :row_name => @row.name}] %>
    				  <li>

                <span class="button">
                  <span class="highlighted">
                    <%= icon "expand" %> 
      					    <%= link_to_unless_current attached_grid.name, :controller => 'rows', :action => 'index', :grid_id => attached_grid.uuid, :filters => @filters %>
                    <%= icon "external" %> 
                  </span>
                </span>
                <% unless attached_grid.description.nil? %>
                  <span title="<%= attached_grid.description.html_safe %>"><%= icon('information') %></span>
                <% end %>
                <span class="detail-article"><%= attached_grid.column_name.html_safe %></span>
    				  </li>
    			<% end %>
          <% if @grid.uuid == Grid::ROOT_UUID %>
    		    <% for attached_grid in Grid.select_referenced_grids(@row.uuid) %>
    		      <li>
  		          <%= icon "table" %> 
                <%= link_to_unless_current attached_grid.name, 
                                           :controller => 'rows', :action => 'show', :grid_id => Grid::ROOT_UUID,
                                         :id => attached_grid.uuid %>
                <span title="<%= attached_grid.description.html_safe %>"><%= icon('information') %></span>
                <span class="detail-article"><%= attached_grid.column_name.html_safe %></span>
    		      </li>
    		    <% end %>
    			<% end %>
    		<% end %>
    	</ul>
    </article>
  <% end %>
<% end %>

<% content_for :document do %>
  <% unless @grid.blank? or @row.blank? %>
    <%= render :partial => 'entities/row', :locals => { :grid => @grid, :row => @row, :row_loc => @row_loc } %>
    <% for attached_grid in Grid.select_referenced_grids(@grid.uuid) %>
      <% @filters = [{:column_uuid => attached_grid.column_uuid, :row_uuid => @row.uuid, :row_name => @row.name}] %>
      <% attached_grid.load_cached_grid_structure(@filters) %>
      <article class="article">
        <header class="header-article-level2">
          <h2>
            <span class="title"><%= attached_grid.name %></span>
            <span class="detail-article"><%= attached_grid.column_name.html_safe %></span>
          </h2>
        </header>
        <div id="<%=h "list-grid" + attached_grid.id.to_s + "-" + get_filters_uuid(@filters) %>">
          <%= render :partial => "home/loading" %>
        </div>
        <script>
          $("#<%=h "list-grid" + attached_grid.id.to_s + "-" + get_filters_uuid(@filters) %>").load(
            "<%= url_for(:action => :search_list, 
                         :grid_id => attached_grid.uuid,
                         :id => 0,
                         :filters => @filters,
                         :embedded => true
                         ) %>");
        </script>
      </article>                                
    <% end %>
  <% else %>
    <h2><%= @page_title %></h2>
  <% end %>
<% end %>