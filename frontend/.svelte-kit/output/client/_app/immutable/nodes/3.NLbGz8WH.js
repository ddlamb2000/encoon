import{a as p,t as w,c as qe,h as yt,d as Ee}from"../chunks/disclose-version.JDsS39X6.js";import{A as Ge,G as pt,aK as We,aL as gt,z as bt,D as wt,U as St,T as kt,N as xt,ap as Dt,u as It,aE as Xe,aD as Ye,p as et,a as tt,s as v,c as l,r as n,t as E,f as ue,d as t,aF as x,e as d,ak as Ct}from"../chunks/runtime.BU7-Umqy.js";import{l as at,s as N,d as Nt,e as Ot}from"../chunks/render.D-xr2h7m.js";import{a as Tt,i as $,p as T}from"../chunks/if.BqxraM_x.js";import{e as z,i as Z}from"../chunks/each.DxMKb2TO.js";import{r as je}from"../chunks/attributes.DefEtgpS.js";import{s as Lt}from"../chunks/class.B8Krk8eY.js";import{o as qt,a as Et}from"../chunks/index-client.b64s7xdh.js";import"../chunks/legacy.Dfcq9YGp.js";import{A as Be,S as At,a as ze,b as Ft}from"../chunks/metadata.DL5znl4j.js";function Ze(e,a,r){Ge&&pt();var f=e,i=Dt,_,g=We()?gt:bt;wt(()=>{g(i,i=a())&&(_&&St(_),_=kt(()=>r(f)))}),Ge&&(f=xt)}function Qe(e,a,r=a){var f=We();at(e,"input",i=>{var _=i?e.defaultValue:e.value;if(_=Ae(e)?Fe(_):_,r(_),f&&_!==(_=a())){var g=e.selectionStart,D=e.selectionEnd;e.value=_??"",D!==null&&(e.selectionStart=g,e.selectionEnd=Math.min(D,e.value.length))}}),(Ge&&e.defaultValue!==e.value||It(a)==null&&e.value)&&r(Ae(e)?Fe(e.value):e.value),Xe(()=>{var i=a();Ae(e)&&i===Fe(e.value)||e.type==="date"&&!i&&!e.value||i!==e.value&&(e.value=i??"")})}function Ae(e){var a=e.type;return a==="number"||a==="range"}function Fe(e){return e===""?null:+e}function ot(e,a,r){if(e.multiple)return Mt(e,a);for(var f of e.options){var i=ce(f);if(Tt(i,a)){f.selected=!0;return}}(!r||a!==void 0)&&(e.selectedIndex=-1)}function Ut(e,a){Ye(()=>{var r=new MutationObserver(()=>{var f=e.__value;ot(e,f)});return r.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),()=>{r.disconnect()}})}function Gt(e,a,r=a){var f=!0;at(e,"change",i=>{var _=i?"[selected]":":checked",g;if(e.multiple)g=[].map.call(e.querySelectorAll(_),ce);else{var D=e.querySelector(_)??e.querySelector("option:not([disabled])");g=D&&ce(D)}r(g)}),Ye(()=>{var i=a();if(ot(e,i,f),f&&i===void 0){var _=e.querySelector(":checked");_!==null&&(i=ce(_),r(i))}e.__value=i,f=!1}),Ut(e)}function Mt(e,a){for(var r of e.options)r.selected=~a.indexOf(ce(r))}function ce(e){return"__value"in e?e.__value:e.value}function Ue(e,a,r,f=r){a.addEventListener("input",()=>{f(a[e])}),Xe(()=>{var i=r();if(a[e]!==i)if(i==null){var _=a[e];f(_)}else a[e]=i+""})}const Kt=[{uuid:"colors",title:"Colors",cols:[{uuid:"colors-col-1",title:"Color",type:"coltypes-row-3"},{uuid:"colors-col-2",title:"Hex",type:"coltypes-row-3"},{uuid:"colors-col-3",title:"Red",type:"coltypes-row-4"},{uuid:"colors-col-4",title:"Green",type:"coltypes-row-4"},{uuid:"colors-col-5",title:"Blue",type:"coltypes-row-4"}],rows:[{uuid:"colors-row-1",data:["IndianRed","#CD5C5C","205","92","92"]},{uuid:"colors-row-2",data:["LightCoral","#F08080","240","128","128"]},{uuid:"colors-row-2",data:["Salmon","#FA8072","250","128","114"]}]},{uuid:"coltypes",title:"Column types",cols:[{uuid:"coltypes-col-1",title:"Type",type:"coltypes-row-3"}],rows:[{uuid:"coltypes-row-1",data:["Any"]},{uuid:"coltypes-row-2",data:["Title"]},{uuid:"coltypes-row-3",data:["String"]},{uuid:"coltypes-row-4",data:["Integer"]},{uuid:"coltypes-row-5",data:["Decimal"]},{uuid:"coltypes-row-6",data:["Date"]},{uuid:"coltypes-row-7",data:["Boolean"]},{uuid:"coltypes-row-8",data:["Text"]},{uuid:"coltypes-row-9",data:["Grid"]},{uuid:"coltypes-row-10",data:["View"]},{uuid:"coltypes-row-11",data:["Image"]},{uuid:"coltypes-row-12",data:["Video"]},{uuid:"coltypes-row-13",data:["Sound"]}]}];function B(){return crypto.randomUUID()}function Rt(e){let a="";for(;e>=0;)a="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[e%26]+a,e=Math.floor(e/26)-1;return a}var Jt=w('<li class="svelte-1u94c12"> </li>'),Pt=w('<ul><li class="svelte-1u94c12"> </li> <li class="svelte-1u94c12"> </li> <li class="svelte-1u94c12"> </li> <li class="svelte-1u94c12">Columns <ul></ul></li> <li class="svelte-1u94c12"> </li></ul>'),$t=w('<li class="request svelte-1u94c12"> </li>'),Ht=w('<li class="svelte-1u94c12"> </li>'),Vt=w("<!> <!>",1),jt=w("<aside><div><p><!></p> <p><!> <!></p></div> <!> <ul></ul></aside>");function Bt(e,a){et(a,!0);var r=jt(),f=l(r),i=l(f),_=l(i);{var g=m=>{var h=qe("Streaming messages");p(m,h)};$(_,m=>{a.isStreaming&&m(g)})}n(i);var D=v(i,2),M=l(D);{var oe=m=>{var h=qe("Sending message");p(m,h)};$(M,m=>{a.isSending&&m(oe)})}var ye=v(M,2);{var A=m=>{var h=qe();E(()=>N(h,a.messageStatus)),p(m,h)};$(ye,m=>{a.messageStatus&&m(A)})}n(D),n(f);var L=v(f,2);{var Q=m=>{var h=Pt(),I=l(h),F=l(I);n(I);var C=v(I,2),W=l(C);n(C);var K=v(C,2),O=l(K);n(K);var S=v(K,2),R=v(l(S));z(R,21,()=>a.focus.grid.cols,Z,(ge,be)=>{var re=Jt(),we=l(re,!0);n(re),E(()=>N(we,t(be).title)),p(ge,re)}),n(R),n(S);var de=v(S,2),pe=l(de);n(de),n(h),E(()=>{N(F,`Grid: ${a.focus.grid.title??""}`),N(W,`i: ${a.focus.i??""}`),N(O,`j: ${a.focus.j??""}`),N(pe,`Content: ${a.focus.grid.rows[a.focus.i].data[a.focus.j]??""}`)}),p(m,h)};$(L,m=>{a.focus.grid!==null&&m(Q)})}var H=v(L,2);z(H,21,()=>a.messageStack,Z,(m,h)=>{var I=Vt(),F=ue(I);{var C=O=>{var S=$t(),R=l(S);E(()=>N(R,`→ ${t(h).request.messageKey??""} ${t(h).request.message.substring(0,200)??""}`)),n(S),p(O,S)};$(F,O=>{t(h).request&&O(C)})}var W=v(F,2);{var K=O=>{var S=Ht(),R=l(S);E(()=>N(R,`← ${t(h).response.messageKey??""} ${t(h).response.message.substring(0,200)??""}`)),n(S),p(O,S)};$(W,O=>{t(h).response&&O(K)})}p(m,I)}),n(H),n(r),p(e,r),tt()}var zt=(e,a)=>a(),Zt=(e,a,r)=>a(t(r)),Qt=(e,a)=>console.log(t(a).type),Wt=w("<option> </option>"),Xt=(e,a,r,f)=>a(t(r),t(f).uuid),Yt=w('<th class="header svelte-h8te8x"><span contenteditable=""> </span> <select></select> <button>-</button></th>'),ea=(e,a,r)=>a(t(r)),ta=(e,a,r,f)=>a(t(r),t(f).uuid),aa=(e,a,r)=>a(t(r)),oa=w('<td><div class="svelte-h8te8x"><span contenteditable=""></span></div></td>'),ra=w('<tr><td class="svelte-h8te8x"><button>-</button> <button>+</button></td><!></tr>'),sa=w('<li class="svelte-h8te8x"><h2> </h2> Filter: <span contenteditable=""></span> <table class="svelte-h8te8x"><thead><tr><th class="svelte-h8te8x"></th><!><th class="svelte-h8te8x"><button>+</button></th></tr></thead><tbody></tbody></table> </li>'),na=(e,a)=>a(),la=w(" <button>Log out</button> <ul><!> <button>New Grid</button></ul>",1),ia=(e,a)=>a(),ua=w('<form><label>Username<input></label> <label>Passphrase<input type="password"></label> <button type="submit">Log in</button></form>'),ca=w('<div class="layout svelte-h8te8x"><main><h1></h1> <!></main> <!></div>');function Sa(e,a){et(a,!0);const r=a.data.dbName,f=a.data.gridUuid,i=a.data.url,_=T(Kt);let g=x(T({grid:null,i:-1,j:-1})),D=x(!1),M=x(""),oe=x(!1),ye=x(!1),A=x(!1),L=x(""),Q=x(""),H=x(""),m=x("");const h=T([{}]);let I=x(void 0),F=x(""),C=x("");qt(()=>{nt(),J({action:Ft,griduuid:f})}),Et(()=>{d(ye,!0),t(I)!==void 0&&t(I).cancel()});function W(o){o.search="",o.columnSeq=o.cols.length,K(o)}function K(o){if(o.search==="")o.rows.forEach(s=>s.filtered=!0);else{const s=new RegExp(o.search,"i");o.rows.forEach(u=>u.filtered=s.test(u.data[0]))}}_.forEach(o=>W(o));async function O(){const o={uuid:B(),title:"Untitled",cols:[{uuid:B(),title:"A",type:"coltypes-row-1"}],rows:[{uuid:B(),data:[""]}]};W(o),_.push(o),J({action:"newgrid",griduuid:o.uuid})}async function S(o){const s=B(),u=[];o.cols.forEach(()=>u.push("")),o.rows.push({uuid:s,data:u,filtered:!0}),J({action:"addrow",griduuid:o.uuid,uuid:s})}async function R(o,s){o.rows=o.rows.filter(u=>u.uuid!==s),J({action:"delrow",griduuid:o.uuid,uuid:s})}async function de(o){const s={uuid:B(),title:Rt(o.columnSeq),type:"coltypes-row-1"};o.cols.push(s),o.columnSeq+=1,o.rows.forEach(u=>u.data.push("")),J({action:"addcol",griduuid:o.uuid,col:s})}async function pe(o,s){const u=o.cols.findIndex(y=>y.uuid===s);o.cols.splice(u,1),o.rows.forEach(y=>y.data.splice(u,1)),J({action:"delcol",griduuid:o.uuid,coluuid:s})}async function ge(o,s,u,y){J({action:"chgcell",griduuid:o.uuid,uuid:s,coluuid:u,value:y})}async function be(){J({action:ze}),localStorage.removeItem(`access_token_${r}`),d(F,""),d(C,""),d(A,!1)}async function re(){Me(!0,{messageKey:B(),headers:[{key:"from",value:i},{key:"initiatedOn",value:new Date().toISOString()}],message:JSON.stringify({action:Be,userid:t(F),password:btoa(t(C))}),selectedPartitions:[]})}function we(o,s,u){d(g,T({grid:o,i:s,j:u}))}function rt(o){return _.find(s=>s.uuid===o)}const st=rt("coltypes");function J(o){Me(!1,{messageKey:B(),headers:[{key:"from",value:i},{key:"initiatedOn",value:new Date().toISOString()},{key:"userUuid",value:t(Q)},{key:"userFirstName",value:t(H)},{key:"userLastName",value:t(m)},{key:"jwt",value:t(L)}],message:JSON.stringify(o),selectedPartitions:[]})}async function Me(o,s){d(D,!0);const u=(o?"/authentication/":"/pushMessage/")+r;if(!o&&!Se()){d(M,"Not authorized to send message");return}console.log(`[Send] to ${u}`,s),h.push({request:s}),d(M,"Sending");const y=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+t(L)},body:JSON.stringify(s)}),k=await y.json();d(D,!1),y.ok?d(M,T(k.message)):d(M,T(k.error||"Failed to send message"))}function Se(){if(d(L,T(localStorage.getItem(`access_token_${r}`))),t(L)!==null&&t(L)!==void 0)try{const o=t(L).split("."),s=JSON.parse(atob(o[1])),u=new Date().toISOString(),y=Date.parse(u),k=Date.parse(s.expires);if(y<k)return d(A,!0),d(Q,T(s.userUuid)),d(H,T(s.userFirstName)),d(m,T(s.userLastName)),!0}catch(o){console.error("Error checking token:",o)}return d(A,!1),d(Q,""),d(H,""),d(m,""),!1}async function nt(){const o="/pullMessages/"+r,u=new AbortController().signal;if(!t(oe)){Se(),console.log(`Start streaming from ${o}`),d(oe,!0);try{const y=await fetch(o,{signal:u});if(!y.ok){console.error(`Failed to fetch stream from ${o}`);return}d(I,T(y.body.pipeThrough(new TextDecoderStream).getReader())),t(I).read().then(function k({done:V,value:se}){if(V){console.log(`Streaming from ${o} stopped`);return}const b=JSON.parse(se),c=JSON.parse(b.value),Re=String.fromCharCode(...b.headers.from.data),ve=String.fromCharCode(...b.headers.requestKey.data),fe=String.fromCharCode(...b.headers.initiatedOn.data),De=new Date().toISOString(),ne=Date.parse(De),le=Date.parse(fe),Ie=ne-le;return console.log(`[Received] from ${o} (${Ie} ms)topic: ${b.topic}, key: ${b.key}, value:`,c,`, headers: {from: ${Re}, requestKey: ${ve}, initiatedOn: ${fe}}`),h.push({response:{messageKey:b.key,message:b.value}}),c.action==Be&&(c.status==At?(console.log(`Logged in: ${c.firstname} ${c.lastname}`),d(A,!0),localStorage.setItem(`access_token_${r}`,c.jwt)):(localStorage.removeItem(`access_token_${r}`),d(C,""),d(A,!1),d(L,""))),c.action==ze?(localStorage.removeItem(`access_token_${r}`),d(C,""),d(A,!1)):Se(),t(I).read().then(k)})}catch{console.log(`Streaming from ${o} stopped`)}}}var ke=ca();yt(o=>{E(()=>Ct.title=`εncooη - ${a.data.dbName??""}`)});var xe=l(ke),Ke=l(xe);Ke.textContent=r;var lt=v(Ke,2);{var it=o=>{var s=la(),u=ue(s),y=v(u);y.__click=[zt,be];var k=v(y,2),V=l(k);z(V,17,()=>_,Z,(b,c,Re)=>{var ve=Ee(),fe=ue(ve);Ze(fe,()=>t(c).uuid,De=>{var ne=sa(),le=l(ne),Ie=l(le,!0);n(le);var Ce=v(le,2);Ce.__input=[Zt,K,c];var Ne=v(Ce,2),Oe=l(Ne),Je=l(Oe),Pe=v(l(Je));z(Pe,17,()=>t(c).cols,Z,(ie,q,P)=>{var X=Yt(),Y=l(X),Te=l(Y,!0);Te.nodeValue=t(q),n(Y);var U=v(Y,2);U.__change=[Qt,q],z(U,21,()=>st.rows,Z,(j,ee)=>{var G=Wt(),te={},me=l(G,!0);n(G),E(()=>{te!==(te=t(ee).uuid)&&(G.value=(G.__value=t(ee).uuid)==null?"":t(ee).uuid),N(me,t(ee).data[0])}),p(j,G)}),n(U);var _e=v(U,2);_e.__click=[Xt,pe,c,q],n(X),Ue("innerHTML",Y,()=>t(c).cols[P].title,j=>t(c).cols[P].title=j),Gt(U,()=>t(q).type,j=>t(q).type=j),p(ie,X)});var $e=v(Pe),dt=l($e);dt.__click=[ea,de,c],n($e),n(Je),n(Oe);var He=v(Oe);z(He,21,()=>t(c).rows,Z,(ie,q,P)=>{var X=Ee(),Y=ue(X);{var Te=U=>{var _e=Ee(),j=ue(_e);Ze(j,()=>t(q).uuid,ee=>{var G=ra(),te=l(G),me=l(te);me.__click=[ta,R,c,q];var ft=v(me,2);ft.__click=[aa,S,c],n(te);var _t=v(te);z(_t,17,()=>t(c).cols,Z,(mt,da,ae)=>{var he=oa(),Ve=l(he),Le=l(Ve);Le.__input=()=>ge(t(c),t(q).uuid,t(c).cols[ae].uuid,t(c).rows[P].data[ae]),n(Ve),n(he),E(()=>Lt(he,`${(t(g).grid!==null&&t(g).grid.uuid===t(c).uuid&&t(g).i===P&&t(g).j===ae?"focus":"cell")??""} svelte-h8te8x`)),Ot("focus",Le,()=>we(t(c),P,ae)),Ue("innerHTML",Le,()=>t(c).rows[P].data[ae],ht=>t(c).rows[P].data[ae]=ht),p(mt,he)}),n(G),p(ee,G)}),p(U,_e)};$(Y,U=>{t(q).filtered&&U(Te)})}p(ie,X)}),n(He),n(Ne);var vt=v(Ne);n(ne),E(()=>{N(Ie,t(c).title),N(vt,` ${t(c).rows.length??""} rows in total`)}),Ue("innerHTML",Ce,()=>t(c).search,ie=>t(c).search=ie),p(De,ne)}),p(b,ve)});var se=v(V,2);se.__click=[na,O],n(k),E(()=>N(u,`${t(Q)??""} ; ${t(H)??""} ; ${t(m)??""} `)),p(o,s)},ut=o=>{var s=ua(),u=l(s),y=v(l(u));je(y),n(u);var k=v(u,2),V=v(l(k));je(V),n(k);var se=v(k,2);se.__click=[ia,re],n(s),Qe(y,()=>t(F),b=>d(F,b)),Qe(V,()=>t(C),b=>d(C,b)),p(o,s)};$(lt,o=>{t(A)?o(it):o(ut,!1)})}n(xe);var ct=v(xe,2);Bt(ct,{get focus(){return t(g)},get messageStack(){return h},get isSending(){return t(D)},get messageStatus(){return t(M)},get isStreaming(){return t(oe)}}),n(ke),p(e,ke),tt()}Nt(["click","input","change"]);export{Sa as component};
